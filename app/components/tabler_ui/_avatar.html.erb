<%
  # Check if using initials or name-based avatar
  use_initials = avatar.respond_to?(:initials) && avatar.initials.present?

  if use_initials
    # Initials-based avatar (simple circle with text)
    initials = avatar.initials.to_s
    # Generate color based on initials
    color_seed = initials.bytes.sum % 360
    bg_color = "hsl(#{color_seed}, 70%, 60%)"
  else
    # Generate unique avatar based on name
    name = avatar.respond_to?(:name) ? avatar.name.to_s : ""
    seed = Zlib.crc32(name)
    srand(seed)

    def rand_color
      "hsl(#{rand(360)}, #{rand(40..80)}%, #{rand(40..70)}%)"
    end

    shapes = 5.times.map do
      {
        type: [:circle, :rect].sample,
        cx: rand(0..40),
        cy: rand(0..40),
        r: rand(5..12),
        size: rand(10..25),
        fill: rand_color,
        rotate: rand(360)
      }
    end
  end

  # Size class (defaults to avatar-sm)
  size_class = avatar.respond_to?(:size) ? "avatar-#{avatar.size}" : "avatar-sm"

  # Shape class (defaults to rounded for initials, rounded-0 for generated)
  if avatar.respond_to?(:shape)
    shape_class = "rounded-#{avatar.shape}"
  else
    shape_class = use_initials ? "rounded" : "rounded-0"
  end
%>

<% if use_initials %>
  <span class="avatar <%= size_class %> <%= shape_class %>" style="background-color: <%= bg_color %>;">
    <%= initials %>
  </span>
<% else %>
  <svg viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg" class="avatar <%= size_class %> <%= shape_class %>">
    <% shapes.each do |shape| %>
      <% if shape[:type] == :circle %>
        <circle cx="<%= shape[:cx] %>" cy="<%= shape[:cy] %>" r="<%= shape[:r] %>" fill="<%= shape[:fill] %>"/>
      <% else %>
        <rect
          x="<%= shape[:cx] %>"
          y="<%= shape[:cy] %>"
          width="<%= shape[:size] %>"
          height="<%= shape[:size] %>"
          fill="<%= shape[:fill] %>"
          transform="rotate(<%= shape[:rotate] %>, <%= shape[:cx] %>, <%= shape[:cy] %>)"
          />
      <% end %>
    <% end %>
  </svg>
<% end %>
<% if avatar.respond_to?(:show_details) && avatar.show_details %>
  <div class="d-none d-xl-block ps-2">
    <% if avatar.respond_to?(:title) && avatar.title.present? %>
      <div><%= avatar.title %></div>
    <% end %>
    <% if avatar.respond_to?(:subtitle) && avatar.subtitle.present? %>
      <div class="mt-1 small text-secondary"><%= avatar.subtitle %></div>
    <% end %>
  </div>
<% end %>
